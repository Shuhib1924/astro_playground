---
import "@tailwind";
export const prerender = false;

import { db, User_a1, eq } from "astro:db";
import bcrypt from "bcryptjs";
import { randomUUID, createHmac } from "node:crypto";

let email = "";
let error = "";
let message = "";
let csrfToken = "";

// Reuse session + CSRF helpers so you can optionally auto-login after register
function getSecret() {
  return (
    process.env.SESSION_SECRET ||
    import.meta.env.SESSION_SECRET ||
    "dev-insecure-secret"
  );
}
function sign(payload) {
  return createHmac("sha256", getSecret()).update(payload).digest("hex");
}
function createSessionCookie(userId, maxAgeSec = 60 * 60 * 24 * 7) {
  const exp = Math.floor(Date.now() / 1000) + maxAgeSec;
  const payload = `${userId}.${exp}`;
  const sig = sign(payload);
  return { value: `${payload}.${sig}`, maxAgeSec };
}
function setCsrfCookie() {
  csrfToken = randomUUID();
  Astro.cookies.set("csrf_token", csrfToken, {
    path: "/",
    httpOnly: false,
    sameSite: "lax",
    secure: import.meta.env.PROD,
    maxAge: 60 * 60,
  });
}

if (Astro.request.method === "GET") {
  setCsrfCookie();
}

if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();
  email = String(form.get("email") ?? "").trim();
  const password = String(form.get("password") ?? "");
  const formToken = String(form.get("csrf_token") ?? "");
  const cookieToken = Astro.cookies.get("csrf_token")?.value ?? "";

  if (!formToken || !cookieToken || formToken !== cookieToken) {
    error = "Invalid CSRF token.";
  } else if (!email || !password) {
    error = "Email and password are required.";
  } else if (password.length < 1) {
    error = "Password must be at least 1 character.";
  } else {
    try {
      const [existing] = await db
        .select()
        .from(User_a1)
        .where(eq(User_a1.email, email));
      if (existing) {
        error = "Email already registered.";
      } else {
        const id = randomUUID();
        const passwordHash = await bcrypt.hash(password, 12);
        await db.insert(User_a1).values({ id, email, passwordHash });
        message = "Registration successful.";

        // Optional: auto-login after registration by setting the session cookie
        const session = createSessionCookie(id);
        Astro.cookies.set("session", session.value, {
          path: "/",
          httpOnly: true,
          sameSite: "lax",
          secure: import.meta.env.PROD,
          maxAge: session.maxAgeSec,
        });

        // Rotate CSRF token
        setCsrfCookie();
      }
    } catch (e) {
      console.error(e);
      error = "Registration failed.";
    }
  }

  csrfToken = Astro.cookies.get("csrf_token")?.value ?? csrfToken;
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Register</title>
  </head>
  <body class="min-h-screen bg-gray-50 text-gray-900 antialiased p-6">
    <main
      class="mx-auto w/full max-w-sm bg-white shadow-sm rounded-xl p-6 border border-gray-200"
    >
      <h1 class="text-2xl font-semibold mb-4">Create account</h1>

      {error && <p class="mb-3 text-sm text-red-600">{error}</p>}
      {message && <p class="mb-3 text-sm text-green-600">{message}</p>}

      <form method="POST" class="space-y-4">
        <input type="hidden" name="csrf_token" value={csrfToken} />
        <div>
          <label for="email" class="block text-sm font-medium">Email</label>
          <input
            id="email"
            name="email"
            type="email"
            value={email}
            required
            autocomplete="email"
            placeholder="you@example.com"
            class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label for="password" class="block text-sm font-medium"
            >Password</label
          >
          <input
            id="password"
            name="password"
            type="password"
            required
            autocomplete="new-password"
            placeholder="••••••••"
            class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <button
          type="submit"
          class="w-full rounded-lg bg-emerald-600 text-white font-semibold px-4 py-2 hover:bg-emerald-700"
        >
          Register
        </button>
      </form>

      <p class="mt-4 text-sm">
        Already have an account?
        <a href="/user/login" class="text-blue-600 hover:underline">Log in</a>
      </p>
    </main>
  </body>
</html>
